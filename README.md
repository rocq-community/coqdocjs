# CoqdocJS

CoqdocJS is a little script to dynamically improve the coqdoc output.
The result can be seen here:

https://www.ps.uni-saarland.de/autosubst/doc/Ssr.POPLmark.html

It offers the following features:
- Customizable Unicode display:
	It only changes the display, copy-paste from the website produces pure ASCII.
	It only replaces complete identifiers or notation tokens, possibly terminated by numbers or apostrophes.
	It does not replace randomly, like in "omega." or "tauto."
	To add new symbols, edit [config.js](extra/resources/config.js).
- Proof hiding:
	All proofs longer than one line are hidden by default. They can be uncovered by clicking on "Proof...".

All of this works with the ordinary coqdoc, by asking coqdoc to use a header file including the javascript files and some custom CSS.

## Usage

1. Clone this repository as a subdirectory or submodule;
2. Include [Makefile.doc] in your `Makefile`, or copy it as, e.g., `Makefile.coq.local`;
3. Run `make coqdoc` to build documentations.

A minimal example is shown [here](example).

### Environment Variables
Name | Usage | Default
---|---|---
`COQDOCFLAGS` | Override the flags passed to `coqdoc` | see [Makefile.doc]
`COQDOCEXTRAFLAGS` | Extend the flags passed to `coqdoc` | empty
`COQDOCJS_LN` | If set to `true` then symlink resource files; otherwise copy | `false`
`COQDOCJS_DIR` | Folder containing CoqdocJS | `coqdocjs`
`COQMAKEFILE` | Makefile generated by `coq_makefile` | `Makefile.coq`
`COQDOCJS_STATIC` | If set to `true` then preprocess html files | `false`

### Reducing browser loading time for large files
When `COQDOCJS_STATIC` is set to false (which is the default), the DOM
rewriting logic in [preprocess.js](extra/resources/preprocess.js)
needs to happen every time a page is loaded. For large files with
thousands line of code, the page may freeze for a few seconds until
the browser finishes processing.

By setting `COQDOCJS_STATIC` to true, the DOM rewriting is instead
done by nodejs when running `make`. The resulting transformed html
files can be efficiently loaded by web browsers with very little
latency.

For `COQDOCJS_STATIC` to work, you need to have a working installation
of Node.js (i.e. you should have the commands `npm` and `node`
available in your `PATH` environment variable).

### Browsing the generated files locally
After running `make`, you should find the generated html files under
the `html` subdirectory of your Rocq project.

Since coqdocjs now uses ES6 modules, directly viewing local
html files through your web browser can result in a CORS error due to
the stricter security policy.

Instead, you should set up a local http server to preview the
generated files. For example, here's how to use
[darkhttpd](https://github.com/emikulic/darkhttpd) to set up
a server listening to port 8080 of the local address `127.0.0.1`, with
`toc.html` as the index file.
```sh
darkhttpd ./html --index toc.html --addr 127.0.0.1 --port 8080
```

## Files

- [Makefile.doc](Makefile.doc): a generic Makefile setup that calls coqc and coqdoc with the right parameters
- [config.js](extra/resources/config.js): contains the unicode replacement table
- [coqdoc.css](extra/resources/coqdoc.css): a replacement for the default Coqdoc CSS style. Can be removed to use the default style
- [preprocess.js](extra/resources/preprocess.js): a module containing functions that rewrite the DOM
- [coqdocjs.js](extra/resources/coqdocjs.js) and
  [coqdocjs.css](extra/resources/coqdocjs.css): the script rewriting
  the DOM (if `COQDOCJS_STATIC` is false) and adding the dynamic features with a corresponding CSS style
- [header.html](extra/header.html) and [footer.html](extra/footer.html): custom header and footer files used in every generated html file

[Makefile.doc]: Makefile.doc
